<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Ekamanam - The Art of Focused Learning. AI Powered NCERT Study Companion.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ekamanam - The Art of Focused Learning</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkVrYW1hbmFtIiwKICAic2hvcnRfbmFtZSI6ICJFa2FtYW5hbSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0ZjQ2ZTUiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8zOTc2LzM5NzY2MjUucG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3976/3976625.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize worker immediately
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        } else {
            window.onload = function() {
                if (window.pdfjsLib) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
            };
        }
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { initializeApp, getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, arrayUnion, increment };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        .font-serif { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .popover-enter { animation: popoverIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes popoverIn { from { opacity: 0; transform: scale(0.9) translateY(5px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .animate-slide-in { animation: slideInDown 0.3s ease-out forwards; }
        @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* --- CRITICAL PDF TEXT LAYER STYLES --- */
        .pdf-wrapper { position: relative; display: inline-block; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
            z-index: 10;
            user-select: text; 
        }

        .textLayer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        /* Pale Yellow Highlight for selection */
        .textLayer ::selection {
            background: rgba(255, 235, 59, 0.4);
        }
        
        /* Notes rendering styles */
        .prose { line-height: 1.6; }
        .prose strong { font-weight: 600; color: #1f2937; }
        .prose em { font-style: italic; }
        .prose h3 { font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose h4 { font-size: 1em; margin-top: 0.75em; margin-bottom: 0.25em; }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { margin-left: 1.25em; list-style: disc; }
        .prose li { margin-bottom: 0.25em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE INIT ---
        // NOTE: Replace this with your actual Firebase configuration
    // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCCIww51kzyr3eN2oJn24D7SmFptfdK_2o",
  authDomain: "ekamanam.firebaseapp.com",
  projectId: "ekamanam",
  storageBucket: "ekamanam.firebasestorage.app",
  messagingSenderId: "662515641730",
  appId: "1:662515641730:web:a1534c00347df3cc0cb39b"
};
        
        // Check if Firebase is actually configured
        const isFirebaseConfigured = firebaseConfig.apiKey !== "AIzaSyDEMOKEY-REPLACE-WITH-YOUR-ACTUAL-KEY";
        
        let app, auth, db;
        if (isFirebaseConfigured) {
            try {
                app = window.firebaseModules.initializeApp(firebaseConfig);
                auth = window.firebaseModules.getAuth(app);
                db = window.firebaseModules.getFirestore(app);
                console.log("✅ Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
                console.warn("Firebase features disabled. Check your configuration.");
            }
        } else {
            console.info("ℹ️ Firebase not configured. App will work in local-only mode. To enable cloud sync and Google Sign-In, configure Firebase in index.html");
        }
        const appId = 'ekamanam-v1';

        // --- DATA: NCERT SYLLABUS ---
        const ncertCatalog = {
            "Mathematics": { 
                "Ganita Prakash": { 
                    code: "hemh1", 
                    chapters: [
                        "Playing with Numbers",
                        "Squares, Square Roots, Cubes and Cube Roots",
                        "Rational Numbers",
                        "Exponents and Powers",
                        "Linear Equations in One Variable",
                        "Quadrilaterals",
                        "Data Handling",
                        "Mensuration",
                        "Algebraic Expressions",
                        "Comparing Quantities",
                        "Introduction to Graphs"
                    ] 
                } 
            },
            "Science": { 
                "Curiosity": { 
                    code: "hesc1", 
                    chapters: [
                        "Microorganisms: Friends and Foe",
                        "Combustion and Flame",
                        "Conservation of Plants and Animals",
                        "Reproduction in Animals",
                        "Sound",
                        "Force and Pressure",
                        "Friction",
                        "Chemical Effects of Electric Current",
                        "Some Natural Phenomena",
                        "Light",
                        "Stars and the Solar System",
                        "Pollution of Air and Water"
                    ] 
                } 
            },
            "Social Science": { 
                "History": { 
                    code: "hess1", 
                    chapters: [
                        "How, When and Where",
                        "From Trade to Territory",
                        "Ruling the Countryside",
                        "Tribals, Dikus and the Vision of a Golden Age",
                        "When People Rebel",
                        "Weavers, Iron Smelters and Factory Owners",
                        "Civilising the Native, Educating the Nation",
                        "Women, Caste and Reform",
                        "The Making of the National Movement",
                        "India After Independence"
                    ] 
                }, 
                "Geography": { 
                    code: "hess4", 
                    chapters: [
                        "Resources",
                        "Land, Soil, Water, Natural Vegetation and Wildlife Resources",
                        "Mineral and Power Resources",
                        "Agriculture",
                        "Industries",
                        "Human Resources"
                    ] 
                } 
            },
            "English": { 
                "Honeydew": { 
                    code: "hehd1", 
                    chapters: [
                        "The Best Christmas Present in the World",
                        "The Tsunami",
                        "Glimpses of the Past",
                        "Bepin Choudhury's Lapse of Memory",
                        "The Summit Within",
                        "This is Jody's Fawn",
                        "A Visit to Cambridge",
                        "A Short Monsoon Diary",
                        "The Great Stone Face"
                    ] 
                } 
            }
        };

        // --- HELPER: Icons ---
        const Icon = ({ name, size = 18, className = "", onClick }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (!spanRef.current) return;
                spanRef.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                spanRef.current.appendChild(i);
                if (window.lucide) window.lucide.createIcons({ root: spanRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
            }, [name, size, className]);
            return <span ref={spanRef} onClick={onClick} className={`inline-flex items-center justify-center ${className} ${onClick ? 'cursor-pointer' : ''}`} style={{ width: size, height: size }} />;
        };

        // --- COMPONENT: Advanced PDF Viewer ---
        const AdvancedPDFViewer = ({ fileUrl, pageNum, onPageChange, onTextSelect, onLoadOutline, onPdfLoaded }) => {
            const canvasRef = useRef(null);
            const textLayerRef = useRef(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [pageCount, setPageCount] = useState(0);
            const [scale, setScale] = useState(1.5);
            const [loading, setLoading] = useState(true);

            // Load PDF
            useEffect(() => {
                const loadPdf = async () => {
                    if (!window.pdfjsLib) {
                        console.warn("PDF.js not loaded yet");
                        return;
                    }
                    setLoading(true);
                    try {
                        const loadingTask = window.pdfjsLib.getDocument(fileUrl);
                        const pdf = await loadingTask.promise;
                        setPdfDoc(pdf);
                        if (onPdfLoaded) onPdfLoaded(pdf);
                        setPageCount(pdf.numPages);
                        
                        const outline = await pdf.getOutline();
                        if (outline && onLoadOutline) {
                            const processedOutline = await Promise.all(outline.map(async (item) => {
                                try {
                                    let dest = item.dest;
                                    if (typeof dest === 'string') dest = await pdf.getDestination(dest);
                                    if (dest && dest.length > 0) {
                                        const ref = dest[0];
                                        const pageIndex = await pdf.getPageIndex(ref);
                                        return { title: item.title, page: pageIndex + 1 };
                                    }
                                } catch (e) { }
                                return null;
                            }));
                            onLoadOutline(processedOutline.filter(Boolean));
                        } else if (onLoadOutline) {
                            onLoadOutline([]);
                        }
                        setLoading(false);
                    } catch (err) {
                        console.error(err);
                        setLoading(false);
                    }
                };
                if (fileUrl) loadPdf();
            }, [fileUrl]);

            // Render Page & Text Layer
            useEffect(() => {
                const renderPage = async () => {
                    if (!pdfDoc || !canvasRef.current || !textLayerRef.current) return;
                    
                    const safePageNum = Math.min(Math.max(1, pageNum), pageCount || 1);
                    const page = await pdfDoc.getPage(safePageNum);
                    const viewport = page.getViewport({ scale });
                    const canvas = canvasRef.current;
                    const context = canvas.getContext('2d');
                    
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    const textContent = await page.getTextContent();
                    const textLayerDiv = textLayerRef.current;
                    
                    textLayerDiv.innerHTML = '';
                    textLayerDiv.style.height = `${viewport.height}px`;
                    textLayerDiv.style.width = `${viewport.width}px`;
                    textLayerDiv.style.setProperty('--scale-factor', scale);

                    await window.pdfjsLib.renderTextLayer({
                        textContentSource: textContent,
                        container: textLayerDiv,
                        viewport: viewport,
                        textDivs: []
                    }).promise;
                };
                renderPage();
            }, [pdfDoc, pageNum, scale, pageCount]);

            return (
                <div className="flex flex-col h-full items-center bg-gray-100 overflow-hidden relative">
                    {loading && <div className="absolute inset-0 flex items-center justify-center bg-white/80 z-20">Loading Document...</div>}
                    
                    <div className="flex-1 overflow-auto w-full flex justify-center p-8" onMouseUp={onTextSelect}>
                        <div className="pdf-wrapper bg-white" style={{ position: 'relative' }}>
                            <canvas ref={canvasRef} className="block" />
                            <div ref={textLayerRef} className="textLayer" />
                        </div>
                    </div>

                    <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur border border-gray-200 p-2 rounded-full shadow-xl flex items-center gap-4 z-30">
                        <button disabled={pageNum <= 1} onClick={() => onPageChange(Math.max(1, pageNum - 1))} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30"><Icon name="arrow-left" size={20}/></button>
                        <span className="text-sm font-bold font-mono px-2">Page {pageNum} / {pageCount}</span>
                        <button disabled={pageNum >= pageCount} onClick={() => onPageChange(Math.min(pageCount, pageNum + 1))} className="p-2 hover:bg-gray-100 rounded-full disabled:opacity-30"><Icon name="arrow-right" size={20}/></button>
                        <div className="w-px h-4 bg-gray-300 mx-1"></div>
                        <button onClick={() => setScale(s => Math.max(0.8, s - 0.2))} className="p-2 hover:bg-gray-100 rounded-full"><Icon name="zoom-out" size={18}/></button>
                        <span className="text-xs font-bold text-gray-500">{Math.round(scale*100)}%</span>
                        <button onClick={() => setScale(s => Math.min(3.0, s + 0.2))} className="p-2 hover:bg-gray-100 rounded-full"><Icon name="zoom-in" size={18}/></button>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Focus Widget ---
        const FocusMoodWidget = ({ onAlert }) => {
            const videoRef = useRef(null);
            const [mood, setMood] = useState('Init...');
            const [status, setStatus] = useState('Good');
            const [isActive, setIsActive] = useState(false); // Start disabled by default
            const [isMinimized, setIsMinimized] = useState(false);
            const [error, setError] = useState(null);
            const streamRef = useRef(null);

            useEffect(() => {
                if (!isActive) {
                    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                    if (videoRef.current) videoRef.current.srcObject = null;
                    setError(null);
                    return;
                }
                const loadModels = async () => {
                    try {
                        setMood('Loading...');
                        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                        await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)]);
                        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                        streamRef.current = stream;
                        if(videoRef.current) videoRef.current.srcObject = stream;
                        setMood('Ready');
                        setError(null);
                    } catch(e) {
                        console.error("Focus widget error:", e);
                        setError(e.name === 'NotAllowedError' ? 'Camera access denied' : 'Setup failed');
                        setMood('Error');
                    }
                };
                loadModels();
                return () => { if(streamRef.current) streamRef.current.getTracks().forEach(t => t.stop()); }
            }, [isActive]);

            const handleVideoPlay = () => {
                const interval = setInterval(async () => {
                    if (!isActive || !videoRef.current || videoRef.current.paused) return;
                    try {
                        const detections = await faceapi.detectAllFaces(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                        if (detections.length > 0) {
                            const sorted = Object.entries(detections[0].expressions).sort((a, b) => b[1] - a[1]);
                            const dom = sorted[0][0];
                            setMood(dom);
                            if (['neutral', 'sad', 'fearful'].includes(dom)) {
                                setStatus('Distracted'); onAlert(true);
                            } else {
                                setStatus('Focus');
                                onAlert(false);
                            }
                        }
                    } catch(e) {}
                }, 1000);
                return () => clearInterval(interval);
            };

            return (
                <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end gap-2 transition-all">
                    <div className="flex items-center gap-2 bg-white p-1.5 rounded-full shadow-lg border border-gray-200">
                        <button onClick={() => setIsActive(!isActive)} className={`p-2 rounded-full shadow transition-colors ${isActive?'bg-red-500 text-white hover:bg-red-600':'bg-gray-400 text-white hover:bg-gray-500'}`} title={isActive ? "Stop Focus Monitor" : "Start Focus Monitor"}><Icon name="power" size={14}/></button>
                        {isActive && (
                            <>
                                <button onClick={() => setIsMinimized(!isMinimized)} className="p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200"><Icon name={isMinimized ? "chevron-up" : "chevron-down"} size={14}/></button>
                                <div className={`px-3 py-1 rounded-full text-xs font-bold border ${error?'bg-amber-100 text-amber-700':status==='Distracted'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}`}>
                                    {error || status}
                                </div>
                            </>
                        )}
                    </div>
                    {isActive && !isMinimized && !error && (
                        <div className="w-32 h-24 rounded-lg overflow-hidden border-4 border-white shadow-xl relative bg-black fade-in">
                            <video ref={videoRef} autoPlay muted playsInline onPlay={handleVideoPlay} className="w-full h-full object-cover transform scale-x-[-1] opacity-90"/>
                            <div className="absolute bottom-0 w-full bg-black/60 text-white text-[10px] text-center py-0.5 font-mono uppercase tracking-wider">{mood}</div>
                        </div>
                    )}
                    {isActive && !isMinimized && error && (
                        <div className="w-48 bg-amber-50 border border-amber-200 rounded-lg p-3 shadow-xl text-xs">
                            <p className="font-bold text-amber-900 mb-1">Focus Monitor Unavailable</p>
                            <p className="text-amber-700">{error === 'Camera access denied' ? 'Please allow camera access in your browser settings.' : 'Could not initialize. Check browser compatibility.'}</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: Teacher Mode ---
        const TeacherMode = ({ pdfDoc, pageNum, chapterName, subject, onClose, openSettings }) => {
            const [state, setState] = useState('loading'); // loading, no-key, error, ready
            const [data, setData] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const apiKey = localStorage.getItem('gemini_pat');

            useEffect(() => {
                const fetchTeacherExplanation = async () => {
                    if (!apiKey) { setState('no-key'); return; }
                    if (!pdfDoc) { setState('error'); setErrorMsg('No PDF loaded'); return; }
                    
                    setState('loading');
                    try {
                        // Extract text from current page
                        const page = await pdfDoc.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        if (!pageText || pageText.trim().length < 50) {
                            throw new Error('Could not extract enough text from page');
                        }

                        // Determine subject-specific instructions
                        let subjectSpecificInstructions = '';
                        if (subject === 'English') {
                            subjectSpecificInstructions = `
                            SPECIAL FOCUS FOR ENGLISH:
                            - Extract ALL "Comprehension Check" questions if present
                            - Include vocabulary words and their meanings
                            - Note literary devices used (metaphors, similes, etc.)
                            - Identify main characters and themes
                            `;
                        } else if (subject === 'Mathematics') {
                            subjectSpecificInstructions = `
                            SPECIAL FOCUS FOR MATHEMATICS:
                            - Extract ALL formulas and mathematical expressions exactly as shown
                            - Include ALL worked examples with step-by-step solutions
                            - Highlight important theorems or properties
                            - Note any special techniques or tricks mentioned
                            `;
                        } else if (subject === 'Science') {
                            subjectSpecificInstructions = `
                            SPECIAL FOCUS FOR SCIENCE:
                            - Extract highlighted/boxed important points
                            - Include definitions of scientific terms
                            - Note experimental procedures if mentioned
                            - Highlight key facts and observations
                            `;
                        } else {
                            subjectSpecificInstructions = `
                            SPECIAL FOCUS:
                            - Extract any questions, exercises, or review sections
                            - Include important definitions and terms
                            - Note any highlighted or boxed content
                            `;
                        }

                        const prompt = `
                            You are an experienced and friendly teacher for Grade 8 students. 
                            
                            Subject: ${subject}
                            Chapter: ${chapterName}
                            
                            ${subjectSpecificInstructions}
                            
                            Page Content:
                            "${pageText.substring(0, 3000)}"
                            
                            Explain this page content as a teacher would in class. 
                            
                            IMPORTANT: Return ONLY valid, properly formatted JSON. Use single spaces instead of newlines in HTML strings. Escape all quotes properly.
                            
                            Return this exact structure:
                            {
                                "summary": "2-3 sentence summary (simple HTML with <b> tags only)",
                                "keyPoints": ["point 1 (plain text)", "point 2 (plain text)", "point 3 (plain text)"],
                                "explanation": "Detailed explanation (use <p> and <b> tags, keep in one line)",
                                "importantDetails": "Subject-specific details - For English: Comprehension questions, For Math: Formulas and examples, For Science: Highlighted sections (use <ul><li> tags, keep in one line)",
                                "examples": "Real-world examples (use <p> and <b> tags, keep in one line)",
                                "thinkAbout": "2-3 questions (use <ul><li> tags, keep in one line)",
                                "exam": "Exam tips (use <p> and <b> tags, keep in one line)"
                            }
                            
                            Make it engaging, clear, and encouraging like a good teacher!
                        `;

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: {
                                    temperature: 0.8,
                                    maxOutputTokens: 4096
                                }
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            const errorMsg = errorData.error?.message || '';
                            
                            // Check for quota errors
                            if (errorMsg.includes('quota') || errorMsg.includes('rate limit')) {
                                throw new Error('Rate limit reached. The free Gemini API has limits on requests per minute. Please wait 1-2 minutes and try again. Check usage: https://aistudio.google.com/app/apikey');
                            }
                            
                            throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                        }

                        const result = await response.json();
                        if (!result.candidates || !result.candidates[0]) {
                            throw new Error('No response from AI');
                        }

                        const candidate = result.candidates[0];
                        
                        // Check finish reason
                        if (candidate.finishReason === 'MAX_TOKENS') {
                            throw new Error('Response was too long. This page might have too much content. Try a different page.');
                        }
                        if (candidate.finishReason === 'SAFETY') {
                            throw new Error('Content was flagged by safety filters.');
                        }

                        if (!candidate.content?.parts?.[0]?.text) {
                            throw new Error('Invalid response structure from AI');
                        }

                        let text = candidate.content.parts[0].text
                            .replace(/```json/g, '')
                            .replace(/```/g, '')
                            .trim();

                        // Try to extract JSON if there's extra text
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            text = jsonMatch[0];
                        }

                        let json;
                        try {
                            json = JSON.parse(text);
                        } catch (parseError) {
                            console.error('JSON Parse Error:', parseError);
                            console.log('Raw text:', text);
                            
                            // Try to fix common issues
                            text = text
                                .replace(/\n/g, ' ')  // Replace newlines with spaces
                                .replace(/\r/g, '')   // Remove carriage returns
                                .replace(/\t/g, ' ')  // Replace tabs with spaces
                                .replace(/  +/g, ' '); // Replace multiple spaces with single space
                            
                            try {
                                json = JSON.parse(text);
                            } catch (secondError) {
                                throw new Error('Could not parse AI response. Please try again. The AI might have generated invalid JSON format.');
                            }
                        }
                        
                        setData(json);
                        setState('ready');
                    } catch (e) {
                        console.error('Teacher Mode Error:', e);
                        setErrorMsg(e.message || 'Unknown error');
                        setState('error');
                    }
                };
                fetchTeacherExplanation();
            }, [pdfDoc, pageNum, apiKey, subject]);

            // Text-to-Speech functions
            const stripHtml = (html) => {
                if (!html) return '';
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            };

            const getFemaleVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                
                // Look for specific female voices (in order of preference)
                const femaleNames = [
                    'google uk english female',
                    'google us english female', 
                    'samantha',
                    'victoria',
                    'karen',
                    'susan',
                    'fiona',
                    'zira',
                    'microsoft zira',
                    'microsoft susan'
                ];
                
                // Try to find by name first
                for (const name of femaleNames) {
                    const voice = voices.find(v => v.name.toLowerCase().includes(name));
                    if (voice) return voice;
                }
                
                // Fallback: look for any female voice
                const femaleVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') && 
                    !voice.name.toLowerCase().includes('male')
                );
                
                return femaleVoice || voices[0]; // Return first voice as last resort
            };

            const speakContent = () => {
                if (!data || !window.speechSynthesis) return;
                
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Only speak the Teacher's Explanation section
                const textToSpeak = stripHtml(data.explanation);

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.rate = 0.85; // Slower for better comprehension
                utterance.pitch = 1.1; // Slightly higher pitch for natural female voice
                utterance.volume = 1;
                
                // Wait for voices to load if needed, then set female voice
                if (window.speechSynthesis.getVoices().length > 0) {
                    utterance.voice = getFemaleVoice();
                } else {
                    // Voices not loaded yet, wait for them
                    window.speechSynthesis.onvoiceschanged = () => {
                        utterance.voice = getFemaleVoice();
                    };
                }
                
                utterance.onstart = () => {
                    setIsSpeaking(true);
                    setIsPaused(false);
                };
                
                utterance.onend = () => {
                    setIsSpeaking(false);
                    setIsPaused(false);
                };
                
                utterance.onerror = () => {
                    setIsSpeaking(false);
                    setIsPaused(false);
                };
                
                window.speechSynthesis.speak(utterance);
            };

            const toggleSpeech = () => {
                if (!window.speechSynthesis) {
                    window.alert('Text-to-speech is not supported in your browser');
                    return;
                }

                if (isSpeaking && !isPaused) {
                    window.speechSynthesis.pause();
                    setIsPaused(true);
                } else if (isSpeaking && isPaused) {
                    window.speechSynthesis.resume();
                    setIsPaused(false);
                } else {
                    speakContent();
                }
            };

            const stopSpeech = () => {
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                    setIsSpeaking(false);
                    setIsPaused(false);
                }
            };

            // Stop speech when component unmounts or closes
            useEffect(() => {
                return () => {
                    if (window.speechSynthesis) {
                        window.speechSynthesis.cancel();
                    }
                };
            }, []);

            return (
                <div className="fixed inset-0 z-[250] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col popover-enter shadow-2xl border border-indigo-100">
                        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-green-50 to-emerald-50">
                            <div className="flex items-center gap-2">
                                <div className="bg-green-600 text-white p-2 rounded-lg"><Icon name="user" size={20}/></div>
                                <div>
                                    <h3 className="text-lg font-bold text-green-800">Teacher Mode</h3>
                                    <p className="text-xs text-green-600">Page {pageNum} • {chapterName}</p>
                                </div>
                            </div>
                            <button onClick={onClose}><Icon name="x" size={24} className="text-gray-500 hover:text-gray-800"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white flex-1">
                            {state === 'loading' && (
                                <div className="text-center py-20">
                                    <div className="animate-spin mx-auto mb-4 w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full"></div>
                                    <p className="text-gray-500">Teacher is reading the page...</p>
                                    <p className="text-xs text-gray-400 mt-2">Analyzing content and preparing explanation</p>
                                </div>
                            )}
                            
                            {state === 'no-key' && (
                                <div className="text-center py-20">
                                    <Icon name="key" size={48} className="mx-auto text-gray-300 mb-4"/>
                                    <h3 className="font-bold text-gray-800 mb-2">API Key Required</h3>
                                    <p className="text-sm text-gray-600 mb-4">Add your Gemini API key to use Teacher Mode.</p>
                                    <button onClick={() => { onClose(); openSettings(); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Open Settings</button>
                                </div>
                            )}
                            
                            {state === 'error' && (
                                <div className="text-center py-20">
                                    <Icon name="alert-circle" size={48} className="mx-auto text-red-400 mb-4"/>
                                    <h3 className="font-bold text-gray-800 mb-2">Could Not Generate Explanation</h3>
                                    <p className="text-sm text-gray-600 mb-2">{errorMsg || 'Please try again'}</p>
                                    <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700">Close</button>
                                </div>
                            )}
                            
                            {state === 'ready' && data && (
                                <div className="space-y-6 max-w-3xl mx-auto">
                                    {/* Summary Card */}
                                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
                                        <div className="flex items-center gap-2 mb-3"><Icon name="book-open" size={20} className="text-green-700"/><h4 className="font-bold text-green-900">What's This Page About?</h4></div>
                                        <div className="text-green-800 leading-relaxed" dangerouslySetInnerHTML={{__html: data.summary}} />
                                    </div>

                                    {/* Key Points */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100">
                                        <div className="flex items-center gap-2 mb-4 pb-2 border-b border-blue-100"><Icon name="list" size={20} className="text-blue-600"/><h4 className="font-bold text-blue-900">Key Points to Remember</h4></div>
                                        <ul className="space-y-2">
                                            {data.keyPoints?.map((point, idx) => (
                                                <li key={idx} className="flex items-start gap-3">
                                                    <span className="bg-blue-100 text-blue-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">{idx + 1}</span>
                                                    <span className="text-gray-700" dangerouslySetInnerHTML={{__html: point}} />
                                                </li>
                                            ))}
                                        </ul>
                                    </div>

                                    {/* Detailed Explanation */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-purple-100">
                                        <div className="flex items-center justify-between mb-4 pb-2 border-b border-purple-100">
                                            <div className="flex items-center gap-2">
                                                <Icon name="message-circle" size={20} className="text-purple-600"/>
                                                <h4 className="font-bold text-purple-900">Teacher's Explanation</h4>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={toggleSpeech}
                                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                                        isSpeaking && !isPaused
                                                            ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' 
                                                            : 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                                                    }`}
                                                    title={isSpeaking && !isPaused ? 'Pause' : isPaused ? 'Resume' : 'Listen to Explanation'}
                                                >
                                                    <Icon name={isSpeaking && !isPaused ? 'pause' : 'volume-2'} size={16}/>
                                                    <span>{isSpeaking && !isPaused ? 'Pause' : isPaused ? 'Resume' : 'Listen'}</span>
                                                </button>
                                                {isSpeaking && (
                                                    <button 
                                                        onClick={stopSpeech}
                                                        className="px-3 py-1.5 rounded-lg text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200 transition-colors"
                                                        title="Stop"
                                                    >
                                                        <Icon name="square" size={16}/>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <div className="text-gray-700 leading-relaxed space-y-3" dangerouslySetInnerHTML={{__html: data.explanation}} />
                                    </div>

                                    {/* Important Details (Subject-specific) */}
                                    {data.importantDetails && (
                                        <div className="bg-gradient-to-br from-cyan-50 to-teal-50 p-6 rounded-xl border-2 border-cyan-200">
                                            <div className="flex items-center gap-2 mb-4">
                                                <Icon name="bookmark" size={20} className="text-cyan-600"/>
                                                <h4 className="font-bold text-cyan-900">
                                                    {subject === 'English' ? 'Comprehension & Key Details' : 
                                                     subject === 'Mathematics' ? 'Formulas & Examples' :
                                                     subject === 'Science' ? 'Important Highlights' : 
                                                     'Important Details'}
                                                </h4>
                                            </div>
                                            <div className="text-cyan-900 leading-relaxed" dangerouslySetInnerHTML={{__html: data.importantDetails}} />
                                        </div>
                                    )}

                                    {/* Examples */}
                                    {data.examples && (
                                        <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-xl border border-amber-200">
                                            <div className="flex items-center gap-2 mb-4"><Icon name="lightbulb" size={20} className="text-amber-600"/><h4 className="font-bold text-amber-900">Real-World Examples</h4></div>
                                            <div className="text-amber-900 leading-relaxed" dangerouslySetInnerHTML={{__html: data.examples}} />
                                        </div>
                                    )}

                                    {/* Think About */}
                                    {data.thinkAbout && (
                                        <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl border border-indigo-200">
                                            <div className="flex items-center gap-2 mb-4"><Icon name="brain" size={20} className="text-indigo-600"/><h4 className="font-bold text-indigo-900">Think About This...</h4></div>
                                            <div className="text-indigo-800 leading-relaxed" dangerouslySetInnerHTML={{__html: data.thinkAbout}} />
                                        </div>
                                    )}

                                    {/* Exam Corner */}
                                    {data.exam && (
                                        <div className="bg-gradient-to-br from-red-50 to-pink-50 p-6 rounded-xl border border-red-200">
                                            <div className="flex items-center gap-2 mb-4"><Icon name="award" size={20} className="text-red-600"/><h4 className="font-bold text-red-900">Exam Corner</h4></div>
                                            <div className="text-red-800 leading-relaxed" dangerouslySetInnerHTML={{__html: data.exam}} />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Module Generator ---
        const ModuleGenerator = ({ chapterName, subject, pdfDoc, pageNum, onClose, openSettings }) => {
            const [state, setState] = useState('loading'); // loading, no-key, error, ready
            const [data, setData] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            const apiKey = localStorage.getItem('gemini_pat');

            useEffect(() => {
                if(!apiKey) { setState('no-key'); return; }
                const fetchModules = async () => {
                    setState('loading');
                    try {
                        let pageContent = '';
                        
                        // Try to extract content from current page if PDF is loaded
                        if (pdfDoc && pageNum) {
                            try {
                                const page = await pdfDoc.getPage(pageNum);
                                const textContent = await page.getTextContent();
                                pageContent = textContent.items.map(item => item.str).join(' ').substring(0, 2000);
                            } catch (e) {
                                console.error('Could not extract page content:', e);
                            }
                        }
                        
                        const prompt = `
                            Generate Class 8 learning modules for Subject: ${subject}, Chapter: "${chapterName}".
                            
                            ${pageContent ? `Context from current page:\n"${pageContent}"\n\nBased on this content, create specific activities.` : 'Create general activities for this chapter.'}
                            
                            IMPORTANT: Return ONLY valid, properly formatted JSON. Keep all HTML strings on single lines. Escape all quotes properly.
                            
                            Return exactly this structure:
                            {
                                "rbl": {
                                    "title": "Research Based Learning Title (specific to content)",
                                    "task": "HTML with <ul><li> tags describing detailed research activities based on the content (keep in one line)"
                                },
                                "cbl": {
                                    "title": "Case Based Learning Title (specific to content)",
                                    "task": "HTML with <ul><li> tags describing detailed case study activities based on the content (keep in one line)"
                                },
                                "sea": {
                                    "title": "Subject Enrichment Activity Title (specific to content)",
                                    "task": "HTML with <ul><li> tags describing detailed creative activities based on the content (keep in one line)"
                                }
                            }
                            Make activities engaging, specific, and age-appropriate for Grade 8. Use actual concepts from the content provided.
                        `;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'}, 
                            body: JSON.stringify({
                                contents:[{parts:[{text:prompt}]}],
                                generationConfig: {
                                    temperature: 0.8,
                                    maxOutputTokens: 4096
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            const errorMsg = errorData.error?.message || '';
                            
                            // Check for quota errors
                            if (errorMsg.includes('quota') || errorMsg.includes('rate limit')) {
                                throw new Error('Rate limit reached. Please wait 1-2 minutes before generating activities again. Free tier limits: 15 requests/minute, 1500/day.');
                            }
                            
                            throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        if (!result.candidates || !result.candidates[0]) {
                            throw new Error('No response from AI');
                        }
                        
                        const candidate = result.candidates[0];
                        
                        // Check finish reason
                        if (candidate.finishReason === 'MAX_TOKENS') {
                            throw new Error('Response was too long. Using fallback activities.');
                        }
                        
                        if (!candidate.content?.parts?.[0]?.text) {
                            throw new Error('Invalid response structure');
                        }
                        
                        let text = candidate.content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                        
                        // Try to extract JSON if there's extra text
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            text = jsonMatch[0];
                        }
                        
                        try {
                            setData(JSON.parse(text));
                        } catch(parseError) {
                            console.error('JSON Parse Error:', parseError);
                            console.log('Raw text:', text);
                            
                            // Try to fix common issues
                            text = text
                                .replace(/\n/g, ' ')
                                .replace(/\r/g, '')
                                .replace(/\t/g, ' ')
                                .replace(/  +/g, ' ');
                            
                            try {
                                setData(JSON.parse(text));
                            } catch(secondError) {
                                // Fallback with safe defaults
                                console.error('Could not parse even after cleanup, using fallback');
                                setData({
                                    rbl: { title: "Research Task", task: "<ul><li>Research the key concepts from this chapter</li><li>Create a detailed report with examples</li></ul>" },
                                    cbl: { title: "Case Study", task: "<ul><li>Find a real-world application of this topic</li><li>Analyze and present your findings</li></ul>" },
                                    sea: { title: "Creative Activity", task: "<ul><li>Create a visual representation (poster/model)</li><li>Present it to your class</li></ul>" }
                                });
                            }
                        }
                        setState('ready');
                    } catch(e) { 
                        console.error('Module Generation Error:', e);
                        setErrorMsg(e.message || 'Unknown error');
                        setState('error'); 
                    }
                };
                fetchModules();
            }, [chapterName, subject, pdfDoc, pageNum, apiKey]);

            const renderModule = (mod) => (
                <>
                    <h4 className="font-bold text-lg mb-2">{mod?.title || "Activity"}</h4>
                    <div className="text-sm leading-relaxed opacity-90" dangerouslySetInnerHTML={{__html: mod?.task || "See chapter for details."}} />
                </>
            );

            return (
                <div className="fixed inset-0 z-[250] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-3xl h-[80vh] flex flex-col popover-enter shadow-2xl border border-indigo-100">
                        <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-50 to-indigo-50">
                            <h3 className="text-xl font-bold text-indigo-800">Activities: {chapterName}</h3>
                            <button onClick={onClose}><Icon name="x" size={24} className="text-gray-500 hover:text-gray-800"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto bg-gray-50 flex-1">
                            {state==='loading' && (
                                <div className="text-center py-20">
                                    <div className="animate-spin mx-auto mb-4 w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full"></div>
                                    <p className="text-gray-500">Generating Custom Activities with AI...</p>
                                </div>
                            )}
                            {state==='no-key' && (
                                <div className="text-center py-20">
                                    <Icon name="key" size={48} className="mx-auto text-gray-300 mb-4"/>
                                    <h3 className="font-bold text-gray-800 mb-2">API Key Required</h3>
                                    <p className="text-sm text-gray-600 mb-4">Add your Gemini API key to generate custom learning activities.</p>
                                    <button onClick={() => { onClose(); openSettings(); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Open Settings</button>
                                </div>
                            )}
                            {state==='error' && (
                                <div className="text-center py-20">
                                    <Icon name="alert-circle" size={48} className="mx-auto text-red-400 mb-4"/>
                                    <h3 className="font-bold text-gray-800 mb-2">Generation Failed</h3>
                                    <p className="text-sm text-gray-600 mb-2">Could not generate activities.</p>
                                    {errorMsg && <p className="text-xs text-red-600 mb-4 font-mono bg-red-50 p-2 rounded max-w-md mx-auto">{errorMsg}</p>}
                                    <div className="flex gap-2 justify-center">
                                        <button onClick={() => window.location.reload()} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Retry</button>
                                        <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700">Close</button>
                                    </div>
                                </div>
                            )}
                            {state==='ready' && data && (
                                <div className="space-y-6">
                                    <div className="bg-blue-100 p-5 rounded-xl border border-blue-200 text-blue-900">
                                        <div className="flex items-center gap-2 mb-3 text-blue-800 font-bold border-b border-blue-200 pb-2"><Icon name="microscope" size={20}/> Research Based Learning (RBL)</div>
                                        {renderModule(data.rbl)}
                                    </div>
                                    <div className="bg-green-100 p-5 rounded-xl border border-green-200 text-green-900">
                                        <div className="flex items-center gap-2 mb-3 text-green-800 font-bold border-b border-green-200 pb-2"><Icon name="briefcase" size={20}/> Case Based Learning (CBL)</div>
                                        {renderModule(data.cbl)}
                                    </div>
                                    <div className="bg-purple-100 p-5 rounded-xl border border-purple-200 text-purple-900">
                                        <div className="flex items-center gap-2 mb-3 text-purple-800 font-bold border-b border-purple-200 pb-2"><Icon name="palette" size={20}/> Subject Enrichment (SEA)</div>
                                        {renderModule(data.sea)}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Interactive AI Research Panel ---
        const AIResearchPanel = ({ term, onClose, onSave, openSettings }) => {
            const [state, setState] = useState('loading'); // loading, error, ready, no-key
            const [data, setData] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            const [retryCount, setRetryCount] = useState(0);
            const apiKey = localStorage.getItem('gemini_pat');

            const fetchData = async () => {
                if (!apiKey) { setState('no-key'); return; }
                setState('loading');
                try {
                        const prompt = `Explain "${term}" for Grade 8 student as JSON:
{
  "explanation": "Clear 2-3 sentence explanation with <b> tags",
  "analogy": "Simple real-world analogy in 1 sentence",
  "pyq": "One exam question example",
  "demo": "Small interactive HTML with button onclick='...' - keep simple"
}
Return ONLY the JSON.`;
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 4096
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            const errorMsg = errorData.error?.message || '';
                            
                            // Check for quota errors
                            if (errorMsg.includes('quota') || errorMsg.includes('rate limit')) {
                                throw new Error('Rate limit reached. The free Gemini API has daily limits. Please wait a few minutes and try again, or check your usage at https://aistudio.google.com/app/apikey');
                            }
                            
                            throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        // Debug log
                        console.log('AI Response:', result);
                        
                        if (!result) {
                            throw new Error('Empty response from AI');
                        }
                        
                        // Check for content filtering
                        if (result.promptFeedback?.blockReason) {
                            throw new Error(`Content was blocked: ${result.promptFeedback.blockReason}. Try selecting different text.`);
                        }
                        
                        if (!result.candidates || result.candidates.length === 0) {
                            console.error('No candidates in response:', result);
                            if (result.promptFeedback) {
                                throw new Error('AI could not generate response. The selected text may have triggered safety filters. Try different text.');
                            }
                            throw new Error('AI did not generate a response. Please try again with different text.');
                        }
                        
                        const candidate = result.candidates[0];
                        
                        console.log('Candidate structure:', JSON.stringify(candidate, null, 2));
                        
                        // Check finish reason
                        if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                            console.warn('Unusual finish reason:', candidate.finishReason);
                            if (candidate.finishReason === 'SAFETY') {
                                throw new Error('Content was flagged by safety filters. Try selecting different text.');
                            }
                            if (candidate.finishReason === 'MAX_TOKENS') {
                                throw new Error('Response was too long and got cut off. Try selecting shorter text or a simpler concept.');
                            }
                            if (candidate.finishReason === 'RECITATION') {
                                throw new Error('Content triggered recitation filter. Try selecting different text.');
                            }
                            // If not STOP but also not one of the known issues, might still have content
                            console.warn('Non-STOP finish reason, but attempting to continue...');
                        }
                        
                        // More flexible content extraction
                        let text = null;
                        
                        // Try different possible response structures
                        if (candidate.content?.parts?.[0]?.text) {
                            text = candidate.content.parts[0].text;
                        } else if (candidate.text) {
                            text = candidate.text;
                        } else if (candidate.output) {
                            text = candidate.output;
                        } else if (typeof candidate === 'string') {
                            text = candidate;
                        }
                        
                        if (!text) {
                            console.error('Invalid candidate structure:', JSON.stringify(candidate, null, 2));
                            throw new Error('Could not extract text from AI response. This may be due to content filtering or an API change. Check console for details.');
                        }
                        
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        
                        // Try to extract JSON if there's extra text
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            text = jsonMatch[0];
                        }

                        let json;
                        try {
                            json = JSON.parse(text);
                        } catch (parseError) {
                            console.error('JSON Parse Error:', parseError);
                            console.log('Raw text:', text);
                            
                            // Try to fix common issues
                            text = text
                                .replace(/\n/g, ' ')  // Replace newlines with spaces
                                .replace(/\r/g, '')   // Remove carriage returns
                                .replace(/\t/g, ' ')  // Replace tabs with spaces
                                .replace(/  +/g, ' '); // Replace multiple spaces with single space
                            
                            try {
                                json = JSON.parse(text);
                            } catch (secondError) {
                                throw new Error('Could not parse AI response. Please try again.');
                            }
                        }
                        
                        // Validate that we have at least the explanation
                        if (!json.explanation) {
                            console.error('Missing explanation in JSON:', json);
                            throw new Error('AI response is missing required explanation field.');
                        }
                        
                        if (json.demo) json.demo = json.demo.replace(/```html/g, '').replace(/```/g, '').trim();
                        
                        setData(json);
                        setState('ready');
                } catch (e) { 
                    console.error('AI Research Error (Full details):', e);
                    console.error('Error stack:', e.stack);
                    setErrorMsg(e.message || 'Unknown error occurred. Check browser console for details.');
                    setState('error'); 
                }
            };

            const handleRetry = () => {
                setRetryCount(prev => prev + 1);
                setErrorMsg('');
                fetchData();
            };

            useEffect(() => {
                fetchData();
            }, [term, apiKey, retryCount]);

            return (
                <div className="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl z-[200] flex flex-col slide-in-right border-l border-gray-200">
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center text-white shrink-0">
                        <div className="flex items-center gap-2 overflow-hidden"><Icon name="sparkles" size={20} /><span className="font-bold truncate">Research: {term}</span></div>
                        <button onClick={onClose} className="hover:bg-white/20 rounded-full p-1"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 bg-gray-50">
                        {state === 'no-key' && (
                            <div className="text-center p-8">
                                <Icon name="key" size={48} className="mx-auto text-gray-300 mb-4"/>
                                <h3 className="font-bold text-gray-800 mb-2">API Key Required</h3>
                                <p className="text-sm text-gray-600 mb-4">Add your Gemini API key in Settings to use AI features.</p>
                                <button onClick={openSettings} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Open Settings</button>
                            </div>
                        )}
                        {state === 'error' && (
                            <div className="text-center p-8">
                                <Icon name="alert-circle" size={48} className="mx-auto text-red-400 mb-4"/>
                                <h3 className="font-bold text-gray-800 mb-2">Could Not Load</h3>
                                <p className="text-sm text-gray-600 mb-2">There was an error getting AI insights.</p>
                                {errorMsg && <p className="text-xs text-red-600 mb-4 font-mono bg-red-50 p-3 rounded max-w-sm mx-auto text-left">{errorMsg}</p>}
                                <div className="flex gap-2 justify-center">
                                    <button onClick={handleRetry} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Try Again</button>
                                    <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700">Close</button>
                                </div>
                                <p className="text-xs text-gray-500 mt-4">Tip: If error persists, try selecting different text or check your API key.</p>
                            </div>
                        )}
                        {state === 'loading' && <div className="space-y-6 p-4 animate-pulse"><div className="h-4 bg-gray-200 rounded w-3/4"></div><div className="h-32 bg-gray-200 rounded w-full"></div><div className="h-4 bg-gray-200 rounded w-2/3"></div></div>}
                        {state === 'ready' && data && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100">
                                    <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-2">Explanation</h4>
                                    <div className="text-gray-800 text-lg leading-relaxed" dangerouslySetInnerHTML={{__html: data.explanation}} />
                                    <div className="mt-3 pt-3 border-t border-gray-100 flex gap-2 items-start"><Icon name="lightbulb" size={18} className="text-yellow-500 mt-1 shrink-0"/><div className="text-gray-600 italic text-sm" dangerouslySetInnerHTML={{__html: data.analogy}} /></div>
                                </div>
                                {data.pyq && <div className="bg-red-50 p-5 rounded-xl border border-red-100"><h4 className="text-xs font-bold text-red-600 uppercase tracking-wider mb-2 flex items-center gap-1"><Icon name="alert-circle" size={14}/> Exam Corner (PYQ)</h4><div className="text-red-900 font-medium italic" dangerouslySetInnerHTML={{__html: data.pyq}} /></div>}
                                {data.demo && <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100"><h4 className="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-4">Interactive Demo</h4><div className="border rounded-lg overflow-hidden h-48 bg-gray-50 relative"><iframe sandbox="allow-scripts" srcDoc={`<!DOCTYPE html><html><head><style>body{margin:0;padding:20px;display:flex;align-items:center;justify-content:center;min-height:100%;font-family:sans-serif;box-sizing:border-box;}*{box-sizing:border-box;}</style></head><body>${data.demo}</body></html>`} className="w-full h-full border-none"/></div></div>}
                                <button onClick={() => { onSave(data.explanation + "<br/><br/>PYQ: " + data.pyq); onClose(); }} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 shadow-md mb-8"><Icon name="save" size={18} /> Save to Chapter Notes</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Notes Panel ---
        const NotesPanel = ({ noteText, setNoteText, handleSaveNote, savedStatus, chapterName }) => {
            const [editMode, setEditMode] = useState(false);
            const [expandedSections, setExpandedSections] = useState({});

            // Auto-expand first section on load
            useEffect(() => {
                if (noteText && Object.keys(expandedSections).length === 0) {
                    setExpandedSections({ 0: true });
                }
            }, [noteText]);

            // Parse notes into sections
            const sections = useMemo(() => {
                if (!noteText) return [];
                const parts = noteText.split(/\n---+\n/);
                return parts.map((part, idx) => {
                    const lines = part.trim().split('\n');
                    const title = lines[0] || `Section ${idx + 1}`;
                    const content = lines.slice(1).join('\n') || part;
                    return { title, content, id: idx };
                });
            }, [noteText]);

            // Convert markdown-like syntax to HTML
            const renderContent = (text) => {
                if (!text) return '';
                let html = text
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')  // **bold**
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')               // *italic*
                    .replace(/^# (.+)$/gm, '<h3 class="font-bold text-lg mb-2">$1</h3>')  // # heading
                    .replace(/^## (.+)$/gm, '<h4 class="font-bold mb-1">$1</h4>')         // ## subheading
                    .replace(/\n\n/g, '</p><p class="mb-2">')             // paragraphs
                    .replace(/\n/g, '<br/>');                              // line breaks
                
                // Wrap in paragraph if not already HTML
                if (!html.includes('<')) {
                    html = `<p class="mb-2">${html}</p>`;
                }
                return html;
            };

            const toggleSection = (id) => {
                setExpandedSections(prev => ({ ...prev, [id]: !prev[id] }));
            };

            const toggleAllSections = () => {
                const allExpanded = sections.every(s => expandedSections[s.id]);
                const newState = {};
                sections.forEach(s => newState[s.id] = !allExpanded);
                setExpandedSections(newState);
            };

            return (
                <div className="w-80 bg-white border-l shadow-xl absolute right-0 top-0 bottom-0 z-20 flex flex-col fade-in">
                    <div className="p-4 border-b bg-yellow-50">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-yellow-800">Chapter Notes</h3>
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-bold text-green-600">{savedStatus}</span>
                                <button 
                                    onClick={() => setEditMode(!editMode)}
                                    className="text-xs px-2 py-1 rounded bg-yellow-200 hover:bg-yellow-300 text-yellow-800 font-medium"
                                    title={editMode ? 'View Mode' : 'Edit Mode'}
                                >
                                    <Icon name={editMode ? 'eye' : 'edit-3'} size={14}/>
                                </button>
                            </div>
                        </div>
                        <p className="text-xs text-yellow-700">{chapterName}</p>
                        {sections.length > 1 && !editMode && (
                            <button 
                                onClick={toggleAllSections}
                                className="text-xs text-yellow-600 hover:text-yellow-800 mt-2"
                            >
                                {sections.every(s => expandedSections[s.id]) ? 'Collapse All' : 'Expand All'}
                            </button>
                        )}
                    </div>
                    
                    {editMode ? (
                        <textarea 
                            value={noteText} 
                            onChange={(e) => setNoteText(e.target.value)} 
                            onBlur={() => handleSaveNote()} 
                            className="flex-1 p-4 text-sm outline-none resize-none bg-yellow-50/30 font-mono" 
                            placeholder="Your notes and AI insights will appear here...&#10;&#10;Tip: Use --- to separate sections&#10;Use **bold** for emphasis"
                        />
                    ) : (
                        <div className="flex-1 overflow-y-auto p-4 bg-yellow-50/30">
                            {sections.length === 0 ? (
                                <p className="text-sm text-gray-500 italic">No notes yet. Click Edit to add notes or save AI insights.</p>
                            ) : sections.length === 1 ? (
                                <div 
                                    className="text-sm text-gray-800 leading-relaxed prose prose-sm max-w-none"
                                    dangerouslySetInnerHTML={{__html: renderContent(sections[0].content)}}
                                />
                            ) : (
                                <div className="space-y-2">
                                    {sections.map((section) => (
                                        <div key={section.id} className="border border-yellow-200 rounded-lg bg-white overflow-hidden">
                                            <button
                                                onClick={() => toggleSection(section.id)}
                                                className="w-full p-3 flex items-center justify-between hover:bg-yellow-50 transition-colors"
                                            >
                                                <span className="font-medium text-sm text-gray-800 line-clamp-1 text-left">
                                                    {section.title.replace(/\*\*/g, '').replace(/\*/g, '')}
                                                </span>
                                                <Icon name={expandedSections[section.id] ? 'chevron-up' : 'chevron-down'} size={16} className="text-gray-500 shrink-0"/>
                                            </button>
                                            {expandedSections[section.id] && (
                                                <div 
                                                    className="p-3 text-sm text-gray-700 leading-relaxed border-t border-yellow-100 prose prose-sm max-w-none"
                                                    dangerouslySetInnerHTML={{__html: renderContent(section.content)}}
                                                />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: Settings Modal ---
        const SettingsModal = ({ onClose, user }) => {
            const [key, setKey] = useState(localStorage.getItem('gemini_pat') || '');
            const [showHelp, setShowHelp] = useState(false);
            const [saving, setSaving] = useState(false);
            
            const handleSave = async () => {
                setSaving(true);
                const trimmedKey = key.trim();
                
                // Always save to localStorage as backup
                localStorage.setItem('gemini_pat', trimmedKey);
                localStorage.setItem('setup_complete', 'true');
                
                // If user is signed in with Google, save to Firebase too
                if (user && db) {
                    try {
                        await window.firebaseModules.setDoc(
                            window.firebaseModules.doc(db, 'users', user.uid),
                            { 
                                apiKey: trimmedKey,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL,
                                lastUpdated: new Date()
                            },
                            { merge: true }
                        );
                        window.alert("API Key Saved & Synced to your Google Account! 🎉"); 
                    } catch (error) {
                        console.error("Error saving to cloud:", error);
                        window.alert("API Key Saved Locally! (Cloud sync unavailable)");
                    }
                } else {
                    window.alert("API Key Saved Locally! Sign in with Google to sync across devices."); 
                }
                
                setSaving(false);
                onClose();
            };
            return (
                <div className="fixed inset-0 z-[300] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"><Icon name="settings" size={24}/> Settings</h2>
                        
                        {/* Google Account Status */}
                        {user ? (
                            <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
                                <div className="flex items-center gap-3">
                                    {user.photoURL && <img src={user.photoURL} alt="Profile" className="w-10 h-10 rounded-full"/>}
                                    <div className="flex-1">
                                        <p className="font-bold text-green-900">{user.displayName || 'User'}</p>
                                        <p className="text-xs text-green-700">{user.email}</p>
                                    </div>
                                    <Icon name="check-circle" size={20} className="text-green-600"/>
                                </div>
                                <p className="text-xs text-green-700 mt-2">✓ Signed in with Google • API key syncs across devices</p>
                            </div>
                        ) : (
                            <div className="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <Icon name="info" size={18} className="text-blue-600"/>
                                    <p className="font-bold text-blue-900">Not Signed In</p>
                                </div>
                                <p className="text-xs text-blue-700 mb-3">Sign in with Google to sync your API key and notes across all devices.</p>
                                <p className="text-xs text-blue-600">Currently using local storage only.</p>
                            </div>
                        )}
                        
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-2">
                                <label className="block text-sm font-bold text-gray-700">Gemini API Key (Required for AI Features)</label>
                                <button onClick={() => setShowHelp(!showHelp)} className="text-indigo-600 text-xs hover:underline">
                                    {showHelp ? 'Hide Help' : 'Need Help?'}
                                </button>
                            </div>
                            
                            {showHelp && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3 text-sm text-gray-700">
                                    <h4 className="font-bold mb-2 text-blue-900">How to get your API Key:</h4>
                                    <ol className="list-decimal ml-4 space-y-1">
                                        <li>Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-indigo-600 underline">Google AI Studio</a></li>
                                        <li>Sign in with your Google account</li>
                                        <li>Click "Get API Key" or "Create API Key"</li>
                                        <li>Copy the key and paste it below</li>
                                    </ol>
                                    <p className="mt-3 text-xs text-gray-600"><strong>Note:</strong> The API key is stored locally in your browser and never shared.</p>
                                </div>
                            )}
                            
                            <input 
                                type="password" 
                                value={key} 
                                onChange={e=>setKey(e.target.value)} 
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm" 
                                placeholder="AIza..."
                            />
                            {key && <p className="text-xs text-green-600 mt-1">✓ Key entered ({key.length} characters)</p>}
                        </div>
                        
                        <div className="bg-gray-50 rounded-lg p-4 mb-6 text-sm">
                            <h4 className="font-bold text-gray-800 mb-2">Features enabled with API Key:</h4>
                            <ul className="space-y-1 text-gray-600">
                                <li className="flex items-center gap-2"><Icon name="check" size={14} className="text-green-600"/> AI-powered text explanations</li>
                                <li className="flex items-center gap-2"><Icon name="check" size={14} className="text-green-600"/> Teacher Mode (page explanations)</li>
                                <li className="flex items-center gap-2"><Icon name="check" size={14} className="text-green-600"/> Interactive learning modules</li>
                                <li className="flex items-center gap-2"><Icon name="check" size={14} className="text-green-600"/> Analogies and visual demos</li>
                                <li className="flex items-center gap-2"><Icon name="check" size={14} className="text-green-600"/> Previous year questions</li>
                            </ul>
                        </div>
                        
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm">
                            <h4 className="font-bold text-blue-900 mb-2 flex items-center gap-2"><Icon name="info" size={16}/> Free Tier Limits</h4>
                            <p className="text-blue-800 text-xs mb-2">Google Gemini API free tier includes:</p>
                            <ul className="space-y-1 text-blue-700 text-xs">
                                <li>• <strong>15 requests per minute</strong></li>
                                <li>• <strong>1,500 requests per day</strong></li>
                                <li>• Sufficient for normal study sessions</li>
                            </ul>
                            <p className="text-blue-600 text-xs mt-2">💡 Tip: If you hit the limit, wait 1-2 minutes before trying again.</p>
                        </div>
                        
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg" disabled={saving}>Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold disabled:opacity-50 flex items-center gap-2" disabled={!key || saving}>
                                {saving && <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>}
                                {saving ? 'Saving...' : 'Save'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Book Reader ---
        const BookReader = ({ subject, book, bookCode, onClose, user, openSettings }) => {
            const [activeChapterIndex, setActiveChapterIndex] = useState(0);
            const [localPdf, setLocalPdf] = useState(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [selection, setSelection] = useState(null);
            const [aiTerm, setAiTerm] = useState(null);
            const [pdfPage, setPdfPage] = useState(() => {
                // Initialize from URL if available
                const params = new URLSearchParams(window.location.search);
                const urlPage = parseInt(params.get('page'));
                return urlPage && urlPage > 0 ? urlPage : 1;
            });
            const [noteText, setNoteText] = useState("");
            const [savedStatus, setSavedStatus] = useState("");
            const [showNotes, setShowNotes] = useState(false);
            const [showModuleGen, setShowModuleGen] = useState(false);
            const [showTeacherMode, setShowTeacherMode] = useState(false);
            const [pdfToc, setPdfToc] = useState([]);

            // Update URL when page changes
            useEffect(() => {
                if (pdfPage > 0) {
                    const params = new URLSearchParams(window.location.search);
                    params.set('page', pdfPage.toString());
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.replaceState({ view: 'reader', bookData: { subject, book, bookCode }, page: pdfPage }, '', newUrl);
                }
            }, [pdfPage, subject, book, bookCode]);
            
            const chapters = ncertCatalog[subject][book].chapters;
            const activeChapterName = localPdf && pdfToc.length > 0 ? (pdfToc.find(i => i.page <= pdfPage)?.title || "Chapter") : (chapters[activeChapterIndex] || "Chapter");
            const onlinePdfUrl = `https://ncert.nic.in/textbook/pdf/${bookCode}${(activeChapterIndex + 1).toString().padStart(2, '0')}.pdf`;

            // Load Notes
            useEffect(() => {
                if (activeChapterName && user && db) {
                    const fetchNote = async () => {
                        try {
                            const docRef = window.firebaseModules.doc(db, 'artifacts', appId, 'users', user.uid, 'notes', activeChapterName);
                            const docSnap = await window.firebaseModules.getDoc(docRef);
                            if (docSnap.exists()) setNoteText(docSnap.data().content);
                            else setNoteText("");
                        } catch (error) {
                            console.error("Error loading notes:", error);
                        }
                    };
                    fetchNote();
                } else if (activeChapterName && !user) {
                    // Load from localStorage as fallback
                    const localKey = `note_${activeChapterName}`;
                    setNoteText(localStorage.getItem(localKey) || "");
                }
            }, [activeChapterName, user]);

            const handleSaveNote = async (additionalContent) => {
                if (!activeChapterName) return;
                setSavedStatus("Saving...");
                let newContent = noteText;
                if (additionalContent) {
                    newContent = noteText ? `${noteText}\n\n---\n${additionalContent}` : additionalContent;
                    setNoteText(newContent);
                }
                try {
                    // Save to cloud if user is authenticated
                    if (user && db) {
                        await window.firebaseModules.setDoc(window.firebaseModules.doc(db, 'artifacts', appId, 'users', user.uid, 'notes', activeChapterName), {
                            chapter: activeChapterName, subject: subject, content: newContent, timestamp: new Date()
                        });
                    }
                    // Always save to localStorage as backup
                    const localKey = `note_${activeChapterName}`;
                    localStorage.setItem(localKey, newContent);
                    
                    setSavedStatus("Saved!");
                    setTimeout(() => setSavedStatus(""), 2000);
                } catch(e) { 
                    console.error("Save error:", e);
                    setSavedStatus("Error"); 
                    setTimeout(() => setSavedStatus(""), 2000);
                }
            };

            const handleAiSave = (explanation) => {
                const noteEntry = `**Term:** ${aiTerm}\n**AI Research:** ${explanation}`;
                handleSaveNote(noteEntry);
                setShowNotes(true); 
            };

            const handleMouseUp = () => {
                const sel = window.getSelection();
                if (sel.toString().trim().length > 0) {
                    const rect = sel.getRangeAt(0).getBoundingClientRect();
                    setSelection({ text: sel.toString(), x: rect.left + rect.width/2, y: rect.top });
                } else setSelection(null);
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const fileURL = URL.createObjectURL(file);
                    setLocalPdf(fileURL);
                    setPdfPage(1);
                    setPdfToc([]); // Clear TOC
                }
            };

            return (
                <div className="h-full flex flex-col bg-white relative">
                    {selection && !aiTerm && (
                        <div 
                            className="fixed z-[150] bg-indigo-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl cursor-pointer popover-enter flex items-center gap-2 hover:bg-indigo-800 hover:scale-105 transition-all"
                            style={{left: selection.x, top: selection.y - 50}}
                            onMouseDown={(e) => { // Use onMouseDown to prevent clearing selection
                                e.preventDefault(); 
                                setAiTerm(selection.text); 
                                setSelection(null); 
                            }}
                        >
                            <Icon name="sparkles" size={14} className="text-yellow-400"/> Explain with AI
                        </div>
                    )}

                    {aiTerm && <AIResearchPanel term={aiTerm} onClose={() => setAiTerm(null)} onSave={handleAiSave} openSettings={openSettings} />}
                    {showModuleGen && <ModuleGenerator chapterName={activeChapterName} subject={subject} pdfDoc={pdfDoc} pageNum={pdfPage} onClose={() => setShowModuleGen(false)} openSettings={openSettings} />}
                    {showTeacherMode && <TeacherMode pdfDoc={pdfDoc} pageNum={pdfPage} chapterName={activeChapterName} subject={subject} onClose={() => setShowTeacherMode(false)} openSettings={openSettings} />}

                    <div className="h-14 border-b flex items-center justify-between px-4 bg-gray-50 shadow-sm z-10 shrink-0">
                        <div className="flex items-center gap-3">
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded text-gray-600"><Icon name="arrow-left" size={20}/></button>
                            <div><h2 className="text-sm font-bold text-gray-800 line-clamp-1">{book}</h2><p className="text-xs text-gray-500">{subject}</p></div>
                        </div>
                        <div className="flex items-center gap-2">
                            {localPdf && pdfDoc && (
                                <button onClick={() => setShowTeacherMode(true)} className="p-2 rounded-lg text-sm font-bold flex items-center gap-2 bg-green-50 text-green-700 hover:bg-green-100 border border-green-200">
                                    <Icon name="user" size={16}/> <span className="hidden md:inline">Teacher Mode</span>
                                </button>
                            )}
                            <button onClick={() => setShowModuleGen(true)} className="p-2 rounded-lg text-sm font-bold flex items-center gap-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100">
                                <Icon name="zap" size={16}/> <span className="hidden md:inline">Activities</span>
                            </button>
                            <button onClick={() => setShowNotes(!showNotes)} className={`p-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors ${showNotes ? 'bg-yellow-100 text-yellow-700' : 'hover:bg-gray-200 text-gray-600'}`}>
                                <Icon name="pen-tool" size={18} /> <span className="hidden md:inline">{showNotes ? 'Hide' : 'Notes'}</span>
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden relative">
                        {/* Sidebar: Only show if local PDF is loaded AND we have a TOC from it */}
                        {(localPdf && pdfToc.length > 0) && (
                            <div className="w-64 border-r bg-gray-50 overflow-y-auto hidden md:block flex-shrink-0">
                                <div className="p-4 text-xs font-bold text-gray-400 uppercase">PDF Contents</div>
                                {pdfToc.map((item, idx) => (
                                    <button key={idx} onClick={() => setPdfPage(item.page)} className="w-full text-left p-3 text-sm border-l-4 border-transparent hover:border-indigo-600 hover:bg-white text-gray-700 transition-colors line-clamp-1">
                                        {item.title}
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* Main Content */}
                        <div className="flex-1 overflow-hidden relative bg-gray-100">
                            {localPdf ? (
                                <AdvancedPDFViewer 
                                    fileUrl={localPdf} 
                                    pageNum={pdfPage}
                                    onPageChange={setPdfPage}
                                    onTextSelect={handleMouseUp}
                                    onLoadOutline={setPdfToc}
                                    onPdfLoaded={setPdfDoc}
                                />
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center p-4 text-center">
                                    <div className="bg-white rounded-xl shadow-sm p-8 max-w-md">
                                        <Icon name="file-text" size={48} className="mx-auto text-gray-300 mb-4"/>
                                        <h3 className="text-lg font-bold text-gray-800 mb-2">Load Chapter</h3>
                                        <p className="text-sm text-gray-500 mb-6">To enable AI features and text selection, please download the chapter PDF and open it here.</p>
                                        <div className="flex flex-col gap-3">
                                            <a href={onlinePdfUrl} target="_blank" rel="noopener noreferrer" className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-200 flex items-center justify-center gap-2"><Icon name="download" size={16}/> 1. Download PDF from NCERT</a>
                                            <label className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 cursor-pointer flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all"><Icon name="upload" size={16}/> 2. Open PDF in App<input type="file" accept="application/pdf" onChange={handleFileChange} className="hidden" /></label>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Side Notes Panel */}
                        {showNotes && (
                            <NotesPanel 
                                noteText={noteText} 
                                setNoteText={setNoteText} 
                                handleSaveNote={handleSaveNote}
                                savedStatus={savedStatus}
                                chapterName={activeChapterName}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Welcome Guide ---
        const WelcomeGuide = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-[300] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="text-center mb-6">
                            <div className="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4">E</div>
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Welcome to Ekamanam!</h1>
                            <p className="text-gray-600">Your AI-powered focus-driven learning companion</p>
                        </div>
                        
                        <div className="space-y-4 mb-8">
                            <div className="flex gap-4 items-start bg-indigo-50 p-4 rounded-lg">
                                <div className="bg-indigo-600 text-white rounded-full p-2 shrink-0"><Icon name="book-open" size={20}/></div>
                                <div>
                                    <h3 className="font-bold text-gray-900 mb-1">NCERT Chapter Access</h3>
                                    <p className="text-sm text-gray-600">Read all Class 8 NCERT books with PDF support and text selection</p>
                                </div>
                            </div>
                            
                            <div className="flex gap-4 items-start bg-purple-50 p-4 rounded-lg">
                                <div className="bg-purple-600 text-white rounded-full p-2 shrink-0"><Icon name="sparkles" size={20}/></div>
                                <div>
                                    <h3 className="font-bold text-gray-900 mb-1">AI-Powered Learning</h3>
                                    <p className="text-sm text-gray-600">Select any text to get instant explanations, analogies, and interactive demos</p>
                                </div>
                            </div>
                            
                            <div className="flex gap-4 items-start bg-green-50 p-4 rounded-lg">
                                <div className="bg-green-600 text-white rounded-full p-2 shrink-0"><Icon name="eye" size={20}/></div>
                                <div>
                                    <h3 className="font-bold text-gray-900 mb-1">Focus Monitoring</h3>
                                    <p className="text-sm text-gray-600">Camera-based focus tracking helps you stay engaged (optional)</p>
                                </div>
                            </div>
                            
                            <div className="flex gap-4 items-start bg-yellow-50 p-4 rounded-lg">
                                <div className="bg-yellow-600 text-white rounded-full p-2 shrink-0"><Icon name="pen-tool" size={20}/></div>
                                <div>
                                    <h3 className="font-bold text-gray-900 mb-1">Smart Notes</h3>
                                    <p className="text-sm text-gray-600">Take notes that sync across devices with automatic AI insights</p>
                                </div>
                            </div>
                        </div>
                        
                        {isFirebaseConfigured && (
                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <h4 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    Sign in with Google (Recommended)
                                </h4>
                                <p className="text-sm text-blue-800 mb-2">Sync your API key and notes across all devices automatically!</p>
                                <p className="text-xs text-blue-700">✓ One-time setup • ✓ Works everywhere • ✓ Secure cloud storage</p>
                            </div>
                        )}
                        
                        {!isFirebaseConfigured && (
                            <div className="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-4">
                                <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <Icon name="info" size={18}/>
                                    Local Mode (No Cloud Sync)
                                </h4>
                                <p className="text-sm text-gray-600 mb-2">The app is running in local-only mode. Your data is stored in this browser only.</p>
                                <p className="text-xs text-gray-500">To enable Google Sign-In and cloud sync, configure Firebase in index.html (see SETUP.md)</p>
                            </div>
                        )}
                        
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                            <h4 className="font-bold text-amber-900 mb-2 flex items-center gap-2"><Icon name="alert-circle" size={18}/> Quick Setup Required</h4>
                            <p className="text-sm text-amber-800 mb-3">To unlock AI features, you'll need a free Google Gemini API key. Don't worry, we'll guide you through it!</p>
                            <p className="text-xs text-amber-700 mb-2">You can always set this up later from Settings.</p>
                            <p className="text-xs text-amber-600"><strong>Free Tier Limits:</strong> 15 requests/minute, 1500 requests/day</p>
                        </div>
                        
                        <button onClick={onClose} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg">
                            Get Started →
                        </button>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Toast Notification ---
        const Toast = ({ alert, onClose }) => {
            useEffect(() => {
                if (alert && alert.duration) {
                    const timer = setTimeout(() => {
                        onClose();
                    }, alert.duration);
                    return () => clearTimeout(timer);
                }
            }, [alert]);

            if (!alert) return null;

            const bgColor = alert.type === 'success' ? 'bg-green-50 border-green-200' : 
                            alert.type === 'warning' ? 'bg-amber-50 border-amber-200' : 
                            'bg-blue-50 border-blue-200';
            const textColor = alert.type === 'success' ? 'text-green-800' : 
                             alert.type === 'warning' ? 'text-amber-800' : 
                             'text-blue-800';

            return (
                <div className="fixed top-20 right-4 z-[400] animate-slide-in">
                    <div className={`${bgColor} border rounded-lg shadow-xl p-4 max-w-md flex items-start gap-3`}>
                        <div className={`${textColor} flex-1`}>
                            <p className="font-medium text-sm">{alert.message}</p>
                        </div>
                        <div className="flex items-center gap-2">
                            {alert.action && (
                                <button 
                                    onClick={() => { alert.action(); onClose(); }}
                                    className={`text-xs font-bold px-3 py-1 rounded ${
                                        alert.type === 'success' ? 'bg-green-600 hover:bg-green-700' :
                                        alert.type === 'warning' ? 'bg-amber-600 hover:bg-amber-700' :
                                        'bg-blue-600 hover:bg-blue-700'
                                    } text-white`}
                                >
                                    {alert.actionText || 'Action'}
                                </button>
                            )}
                            <button onClick={onClose} className={`${textColor} hover:opacity-70`}>
                                <Icon name="x" size={18}/>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [currentBookData, setCurrentBookData] = useState(null);
            const [user, setUser] = useState(null);
            const [toast, setToast] = useState(null);
            const [focusAlert, setFocusAlert] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showWelcome, setShowWelcome] = useState(!localStorage.getItem('welcome_seen'));

            // Load state from URL on initial load
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const subject = params.get('subject');
                const book = params.get('book');
                
                if (subject && book) {
                    // Find the book code
                    const bookCode = ncertCatalog[subject]?.[book]?.code;
                    if (bookCode) {
                        setCurrentBookData({ subject, book, bookCode });
                        setView('reader');
                    }
                }
            }, []);

            // Update URL when view or book changes
            useEffect(() => {
                if (view === 'reader' && currentBookData) {
                    const params = new URLSearchParams();
                    params.set('subject', currentBookData.subject);
                    params.set('book', currentBookData.book);
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.pushState({ view: 'reader', bookData: currentBookData }, '', newUrl);
                } else if (view === 'dashboard') {
                    window.history.pushState({ view: 'dashboard' }, '', window.location.pathname);
                }
            }, [view, currentBookData]);

            // Handle browser back/forward buttons
            useEffect(() => {
                const handlePopState = (event) => {
                    if (event.state?.view === 'reader' && event.state?.bookData) {
                        setCurrentBookData(event.state.bookData);
                        setView('reader');
                    } else {
                        setView('dashboard');
                        setCurrentBookData(null);
                    }
                };
                
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            useEffect(() => {
                if (!auth) {
                    console.warn("Firebase auth not initialized. Cloud features disabled.");
                    return;
                }
                
                // Listen for auth state changes
                const unsubscribe = window.firebaseModules.onAuthStateChanged(auth, async (user) => {
                    setUser(user);
                    
                    // If user signed in, try to load their API key from Firebase
                    if (user && db) {
                        console.log("✅ Signed in as:", user.email);
                        try {
                            const userDocRef = window.firebaseModules.doc(db, 'users', user.uid);
                            const userDoc = await window.firebaseModules.getDoc(userDocRef);
                            
                            if (userDoc.exists() && userDoc.data().apiKey) {
                                const cloudApiKey = userDoc.data().apiKey;
                                const localApiKey = localStorage.getItem('gemini_pat');
                                
                                // Only update if different from local
                                if (localApiKey !== cloudApiKey) {
                                    localStorage.setItem('gemini_pat', cloudApiKey);
                                    console.log('✅ API key loaded from your Google account');
                                    setToast({
                                        type: 'success',
                                        message: '🎉 API Key Loaded from Your Google Account!',
                                        duration: 3000
                                    });
                                } else {
                                    console.log('✅ API key already up to date');
                                }
                            } else {
                                // User doesn't have API key in cloud
                                const localApiKey = localStorage.getItem('gemini_pat');
                                if (!localApiKey) {
                                    console.log('⚠️ No API key found');
                                    // Show prompt after 1 second to let UI settle
                                    setTimeout(() => {
                                        setToast({
                                            type: 'warning',
                                            message: '⚠️ No API Key Found. Click Settings to add one.',
                                            duration: 5000,
                                            action: () => setShowSettings(true),
                                            actionText: 'Add API Key'
                                        });
                                    }, 1000);
                                } else {
                                    // User has local key but not in cloud, offer to sync
                                    console.log('📤 Syncing local API key to your Google account...');
                                    try {
                                        await window.firebaseModules.setDoc(
                                            userDocRef,
                                            {
                                                email: user.email,
                                                displayName: user.displayName,
                                                apiKey: localApiKey,
                                                lastUpdated: new Date()
                                            },
                                            { merge: true }
                                        );
                                        console.log('✅ Local API key synced to cloud');
                                        setToast({
                                            type: 'success',
                                            message: '✅ Your API Key Has Been Synced to Cloud!',
                                            duration: 3000
                                        });
                                    } catch (syncError) {
                                        console.error('Failed to sync API key:', syncError);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error("Error loading user data:", error);
                        }
                    } else if (!user) {
                        // User signed out, don't clear local API key
                        console.log('Signed out');
                    }
                });
                
                return unsubscribe;
            }, []);

            const NCERTDashboard = () => {
                const [selSub, setSelSub] = useState("");
                const [selBook, setSelBook] = useState("");
                const hasApiKey = !!localStorage.getItem('gemini_pat');
                
                return (
                    <div className="max-w-4xl mx-auto p-6 fade-in">
                        <div className="bg-white rounded-xl shadow-sm p-8 text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">E</div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Ekamanam</h1>
                            <p className="text-gray-500 mb-8">Focus-Driven Learning • Class VIII • CBSE & SCERT</p>
                            
                            {!user && isFirebaseConfigured && (
                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-4 max-w-2xl mx-auto">
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                        <p className="font-bold text-blue-900">Sync Across All Devices</p>
                                    </div>
                                    <p className="text-sm text-blue-800 mb-3">Sign in with Google to sync your API key, notes, and progress everywhere!</p>
                                    <button onClick={handleGoogleSignIn} className="bg-white border border-blue-300 text-blue-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-50 shadow-sm">
                                        Sign in with Google
                                    </button>
                                </div>
                            )}
                            
                            {!isFirebaseConfigured && (
                                <div className="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-4 max-w-2xl mx-auto">
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <Icon name="hard-drive" size={20} className="text-gray-600"/>
                                        <p className="font-bold text-gray-700">Local Storage Mode</p>
                                    </div>
                                    <p className="text-sm text-gray-600 mb-2">App is working in local-only mode. Your data is stored in this browser.</p>
                                    <p className="text-xs text-gray-500">Want cloud sync? Configure Firebase to enable Google Sign-In (see SETUP.md)</p>
                                </div>
                            )}
                            
                            {!hasApiKey && (
                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6 max-w-2xl mx-auto">
                                    <p className="text-sm text-amber-800 mb-2">⚠️ AI features disabled. Set up your API key to unlock all features.</p>
                                    <button onClick={() => setShowSettings(true)} className="text-indigo-600 font-bold text-sm hover:underline">
                                        Set up now →
                                    </button>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto text-left">
                                <div><label className="text-xs font-bold text-gray-500 uppercase">Subject</label><select className="w-full p-3 border rounded-lg mt-1 focus:ring-2 focus:ring-indigo-500 outline-none" value={selSub} onChange={e => {setSelSub(e.target.value); setSelBook("")}}><option value="">Select Subject</option>{Object.keys(ncertCatalog).map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                <div><label className="text-xs font-bold text-gray-500 uppercase">Book</label><select className="w-full p-3 border rounded-lg mt-1 focus:ring-2 focus:ring-indigo-500 outline-none" value={selBook} onChange={e => setSelBook(e.target.value)} disabled={!selSub}><option value="">Select Book</option>{selSub && Object.keys(ncertCatalog[selSub]).map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                            </div>
                            <button disabled={!selBook} onClick={() => {setCurrentBookData({subject:selSub, book:selBook, bookCode:ncertCatalog[selSub][selBook].code}); setView('reader')}} className="mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-lg font-bold hover:from-indigo-700 hover:to-purple-700 disabled:opacity-50 disabled:from-gray-300 disabled:to-gray-300 transition-all shadow-lg hover:shadow-xl active:scale-95">Start Reading</button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="bg-white rounded-lg shadow-sm p-5 border-l-4 border-blue-500">
                                <div className="flex items-center gap-3 mb-2">
                                    <Icon name="book" size={24} className="text-blue-500"/>
                                    <h3 className="font-bold text-gray-800">4 Subjects</h3>
                                </div>
                                <p className="text-sm text-gray-600">Complete NCERT curriculum</p>
                            </div>
                            <div className="bg-white rounded-lg shadow-sm p-5 border-l-4 border-purple-500">
                                <div className="flex items-center gap-3 mb-2">
                                    <Icon name="zap" size={24} className="text-purple-500"/>
                                    <h3 className="font-bold text-gray-800">AI Powered</h3>
                                </div>
                                <p className="text-sm text-gray-600">Instant explanations & demos</p>
                            </div>
                            <div className="bg-white rounded-lg shadow-sm p-5 border-l-4 border-green-500">
                                <div className="flex items-center gap-3 mb-2">
                                    <Icon name="target" size={24} className="text-green-500"/>
                                    <h3 className="font-bold text-gray-800">Stay Focused</h3>
                                </div>
                                <p className="text-sm text-gray-600">Smart focus monitoring</p>
                            </div>
                        </div>
                    </div>
                );
            };

            const handleWelcomeClose = () => {
                setShowWelcome(false);
                localStorage.setItem('welcome_seen', 'true');
                // If no API key set, prompt to set it up
                if (!localStorage.getItem('gemini_pat')) {
                    setTimeout(() => setShowSettings(true), 300);
                }
            };

            const handleGoogleSignIn = async () => {
                console.log("=== Google Sign-In Diagnostic ===");
                console.log("Firebase Configured:", isFirebaseConfigured);
                console.log("Auth object exists:", !!auth);
                console.log("Firebase Modules:", window.firebaseModules ? "Loaded" : "Not loaded");
                console.log("Current URL:", window.location.href);
                console.log("================================");
                
                if (!isFirebaseConfigured) {
                    // Show helpful guide instead of just an alert
                    const shouldContinue = confirm(
                        "🔧 Firebase Not Configured\n\n" +
                        "Google Sign-In requires Firebase setup. You have two options:\n\n" +
                        "1. Continue WITHOUT Sign-In (Recommended for quick start)\n" +
                        "   - App works fully\n" +
                        "   - Store API key locally\n" +
                        "   - Notes saved in browser\n\n" +
                        "2. Set up Firebase (For cloud sync)\n" +
                        "   - Follow instructions in SETUP.md\n" +
                        "   - Enable Google Sign-In\n" +
                        "   - Sync across devices\n\n" +
                        "Click OK to continue without sign-in, or Cancel to read setup docs."
                    );
                    
                    if (!shouldContinue) {
                        // Open setup documentation
                        console.log("📚 Firebase Setup Instructions:");
                        console.log("1. Go to https://console.firebase.google.com/");
                        console.log("2. Create a new project");
                        console.log("3. Enable Authentication (Google provider)");
                        console.log("4. Enable Firestore Database");
                        console.log("5. Copy your config and update index.html");
                        console.log("\nSee SETUP.md for detailed instructions.");
                    }
                    return;
                }
                
                if (!auth) {
                    window.alert("Firebase initialization failed. Please check your Firebase configuration in index.html and refresh the page.");
                    return;
                }
                
                try {
                    console.log("Starting Google Sign-In...");
                    const provider = new window.firebaseModules.GoogleAuthProvider();
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });
                    
                    console.log("Opening sign-in popup...");
                    const result = await window.firebaseModules.signInWithPopup(auth, provider);
                    console.log("✅ Successfully signed in:", result.user.email);
                } catch (error) {
                    console.error("Sign-in error (full):", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        // User closed popup, no need to alert
                        console.log("User closed the sign-in popup");
                    } else if (error.code === 'auth/popup-blocked') {
                        window.alert("🚫 Popup Blocked\n\nYour browser blocked the sign-in popup.\n\nTo fix:\n1. Allow popups for this site\n2. Click 'Sign in with Google' again\n\nOR try using a different browser (Chrome recommended)");
                    } else if (error.code === 'auth/unauthorized-domain') {
                        console.error("❌ DOMAIN NOT AUTHORIZED");
                        console.error("Current domain needs to be added to Firebase Console");
                        console.error("\n📋 STEPS TO FIX:\n");
                        console.error("1. Go to: https://console.firebase.google.com/project/ekamanam/authentication/settings");
                        console.error("2. Scroll to 'Authorized domains'");
                        console.error("3. Click 'Add domain' and add:", window.location.hostname);
                        console.error("4. Try signing in again");
                        
                        window.alert("⚠️ Domain Not Authorized\n\nYour current domain (" + window.location.hostname + ") needs to be authorized.\n\nSTEPS TO FIX:\n\n1. Go to Firebase Console:\n   https://console.firebase.google.com/project/ekamanam/authentication/settings\n\n2. Scroll to 'Authorized domains'\n\n3. Click 'Add domain' and add:\n   " + window.location.hostname + "\n\n4. Try signing in again\n\nCheck console for clickable link!");
                    } else if (error.code === 'auth/operation-not-allowed') {
                        window.alert("⚠️ Google Sign-In Not Enabled\n\nSteps to enable in Firebase Console:\n\n1. Go to: https://console.firebase.google.com/\n2. Select your project: ekamanam\n3. Go to Authentication → Sign-in method\n4. Click 'Google' and toggle it to ENABLED\n5. Save changes\n6. Try signing in again");
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        // Multiple popups, just ignore
                        console.log("Popup request cancelled (another popup was opened)");
                    } else {
                        window.alert("❌ Sign-In Failed\n\nError: " + (error.message || "Unknown error") + "\n\nError Code: " + (error.code || "none") + "\n\nCheck browser console (F12) for details.");
                    }
                }
            };

            const handleSignOut = async () => {
                if (!auth) return;
                try {
                    await window.firebaseModules.signOut(auth);
                    // Optionally clear local storage
                    // localStorage.removeItem('gemini_pat'); // Keep it so user can use offline
                } catch (error) {
                    console.error("Sign-out error:", error);
                    window.alert("Could not sign out: " + error.message);
                }
            };

            return (
                <div className="h-screen flex flex-col relative">
                    <FocusMoodWidget onAlert={setFocusAlert} user={user} />
                    <Toast alert={toast} onClose={() => setToast(null)} />
                    {showWelcome && <WelcomeGuide onClose={handleWelcomeClose} />}
                    {focusAlert && <div className="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-white rounded-2xl p-6 text-center max-w-sm animate-bounce shadow-2xl"><Icon name="coffee" size={48} className="mx-auto text-red-500 mb-4"/><h3 className="text-xl font-bold text-gray-900">Focus Dropping!</h3><p className="text-gray-600 mb-4">Take a break?</p><button onClick={() => setFocusAlert(false)} className="bg-indigo-600 text-white px-6 py-2 rounded-full">I'm Back</button></div></div>}
                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} user={user} />}
                    
                    <div className="bg-white border-b px-6 py-3 flex justify-between items-center z-10">
                        <div className="flex items-center gap-2"><div className="bg-indigo-600 p-2 rounded text-white"><Icon name="graduation-cap" size={20}/></div><span className="font-bold text-lg text-gray-800">Ekamanam</span></div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setView('dashboard')} className={`px-4 py-1.5 rounded text-sm font-medium ${view==='dashboard'?'bg-gray-100 text-indigo-600':'text-gray-500'}`}>Library</button>
                            <button onClick={() => setShowSettings(true)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full"><Icon name="settings" size={20}/></button>
                            
                            {user ? (
                                <div className="relative group">
                                    <button className="flex items-center gap-2 p-1.5 hover:bg-gray-100 rounded-full">
                                        <img src={user.photoURL || 'https://via.placeholder.com/32'} alt="Profile" className="w-8 h-8 rounded-full border-2 border-green-500"/>
                                    </button>
                                    <div className="hidden group-hover:block absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 p-3 z-50">
                                        <div className="flex items-center gap-3 mb-3 pb-3 border-b">
                                            <img src={user.photoURL || 'https://via.placeholder.com/40'} alt="Profile" className="w-10 h-10 rounded-full"/>
                                            <div className="flex-1 min-w-0">
                                                <p className="font-bold text-gray-900 truncate">{user.displayName || 'User'}</p>
                                                <p className="text-xs text-gray-600 truncate">{user.email}</p>
                                            </div>
                                        </div>
                                        <button onClick={handleSignOut} className="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">
                                            <Icon name="log-out" size={16}/>
                                            Sign Out
                                        </button>
                                    </div>
                                </div>
                            ) : isFirebaseConfigured ? (
                                <button onClick={handleGoogleSignIn} className="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 shadow-sm">
                                    <svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    Sign in with Google
                                </button>
                            ) : (
                                <div className="text-xs text-gray-500 px-3 py-1.5 bg-gray-100 rounded-lg border border-gray-200" title="Configure Firebase to enable Google Sign-In">
                                    Local Mode
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="flex-1 overflow-hidden bg-gray-50">
                        {view === 'dashboard' && <NCERTDashboard />}
                        {view === 'reader' && <BookReader subject={currentBookData.subject} book={currentBookData.book} bookCode={currentBookData.bookCode} onClose={() => setView('dashboard')} user={user} openSettings={() => setShowSettings(true)} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>